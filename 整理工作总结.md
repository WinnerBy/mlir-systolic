# mlir-systolic 项目整理总结报告

> **生成日期**: 2026-01-06  
> **报告类型**: 综合整理和规划总结  
> **读者**: 项目成员、后续开发者

---

## 执行摘要 (Executive Summary)

本报告系统地梳理了 mlir-systolic 项目的当前状态、存在的问题，以及详细的后续工作规划。

### 关键发现

**✅ 已完成的工作**:
- Spacetime=3 下的矩阵乘法 (MM) kernel 完整实现
- 核心 Pass 框架和 Polymer 集成
- 11 个 AutoSA 参考配置测试通过

**⚠️ 存在的主要问题**:
1. **Spacetime 硬编码** (高优先级) - 仅支持 ST3，不支持其他配置
2. **Kernel 特异性** (高优先级) - 仅支持 MM，不支持其他算子
3. **配置流不清晰** (中优先级) - 参数传递方式不规范
4. **测试覆盖不足** (中优先级) - 仅测试 MM 的 ST3

**📋 建议的改进**:
1. Spacetime 参数化重构 (5-7 天)
2. Kernel 通用化 (5-7 天)
3. 多 kernel 支持 (3-5 天)
4. 硬件验证 (后续)

### 预期收益

完成规划的工作后:
- 📊 支持 6 种 spacetime 配置 (ST0-ST5)
- 🔌 支持至少 3 种 kernel (MM, MTTKRP, CNN)
- ⚡ 代码生成效果与 AutoSA 可比 (PIPELINE 数相同，代码行数 ±10%)
- 🛠️ 系统可维护性和可扩展性显著提高

---

## 文档清单

本整理工作生成了 4 份核心文档:

### 1. [PROJECT_ORGANIZATION_AND_ANALYSIS.md](PROJECT_ORGANIZATION_AND_ANALYSIS.md)

**内容**: 项目整体状况分析

- 文档整理方案 (具体的删除、保留、新建清单)
- 项目完成情况详细评估
- 存在的 5 大类问题分析
- 代码质量评估表
- 后续工作概览

**适合人群**: 项目经理、架构师、新成员了解项目

**关键数据**:
- test/ 有 20+ 个临时文件待清理
- docs/ 需要整合去重
- 5 个主要代码问题需要解决

### 2. [CLEANUP_CHECKLIST.md](CLEANUP_CHECKLIST.md)

**内容**: 文档整理的具体执行清单

- test/ 目录: 15 个文件待删除清单
- docs/ 目录: 4 个文件待删除，结构优化方案
- 新建文档: TESTING_GUIDE.md, CODE_STRUCTURE.md 等
- 执行顺序和验收标准

**适合人群**: 文档维护者、项目清理执行人

**建议执行时间**: 1-2 天

### 3. [CODE_ISSUES_DETAILED_ANALYSIS.md](CODE_ISSUES_DETAILED_ANALYSIS.md)

**内容**: 代码问题的深入分析

- 问题 1: Spacetime=3 硬编码 (具体位置、代码片段、影响范围)
- 问题 2: Kernel 特异性 (具体限制、不支持的场景)
- 问题 3: 配置流混乱 (传递过程、类型转换问题)
- 问题 4-5: 其他技术问题
- 参数化重构方案 (数据结构、设计原理)

**适合人群**: 代码开发者、架构设计师

**核心价值**: 帮助理解为什么现有代码难以扩展，以及如何重构

### 4. [NEXT_STEPS_TECHNICAL_ROADMAP.md](NEXT_STEPS_TECHNICAL_ROADMAP.md)

**内容**: 详细的技术实施规划

- 整体时间线 (2026-01 到 2026-05)
- Phase 1: Spacetime 参数化 (7 天详细计划)
- Phase 2: Kernel 通用化 (7 天详细计划)
- Phase 3: 多 Kernel 支持 (5 天计划)
- Phase 4: 硬件验证 (后续工作)
- 技术决策和风险分析

**适合人群**: 开发经理、技术负责人、核心开发者

**参考价值**: 作为后续 sprint 计划的基础

---

## 整理成果

### 文件清理方案

| 类别 | 操作 | 数量 | 预期成果 |
|------|------|------|---------|
| test/ 临时文件 | 删除 | 15 个 | 目录整洁，核心文件明确 |
| docs/ 组织文件 | 删除 | 4 个 | 文档组织清晰，无重复 |
| spacetime/ 重组 | 优化结构 | 8 个文档 | 便于查找和扩展 |
| 新建文档 | 创建 | 3 个 | TESTING_GUIDE.md 等 |

### 代码问题清单

| 问题 | 位置 | 优先级 | 影响范围 | 修复工作量 |
|------|------|--------|---------|-----------|
| Spacetime=3 硬编码 | 4 个 Pass | P1 | 所有 spacetime | 高 (3-4 天) |
| Kernel 特异性 | 全系统 | P1 | 其他 kernel | 高 (3-4 天) |
| 配置流混乱 | 多个 Pass | P2 | 配置管理 | 中 (1-2 天) |
| 写时重排限制 | 分析模块 | P2 | 重排功能 | 中 (1-2 天) |
| 循环体迁移缺失 | 代码生成 | P1 | 代码正确性 | 高 (2-3 天) |

### 后续工作规划

| 阶段 | 目标 | 工作量 | 预期完成 |
|------|------|--------|---------|
| Phase 1 | Spacetime 参数化 (ST0-ST5) | 5-7 天 | 2026-01-31 |
| Phase 2 | Kernel 通用化 (支持 N 维) | 5-7 天 | 2026-02-28 |
| Phase 3 | 多 Kernel 支持 (MM/MTTKRP/CNN) | 3-5 天 | 2026-03-31 |
| Phase 4 | 硬件验证和优化 | 4-6 周 | 2026-04-30 |

---

## 关键建议

### 建议 1: 立即行动 (本周)

**文档清理**:
1. 删除 test/ 的 15 个临时文件 (参考 CLEANUP_CHECKLIST.md)
2. 整合 docs/spacetime 文档
3. 更新所有交叉引用

**代码标记**:
1. 在 spacetime=3 相关的硬编码处添加 FIXME 注释
2. 创建 CODE_STRUCTURE.md 说明代码组织
3. 添加编译警告或 error 来强制参数化重构

**时间投入**: 8-16 小时

### 建议 2: 获取 AutoSA 代码 (本周内)

**行动**:
1. Clone AutoSA 源码仓库
2. 阅读主要源文件 (sa.cpp, autosa_utils.cpp)
3. 理解以下关键算法:
   - Spacetime 自动选择
   - 多面体分析部分
   - 不同 kernel 的处理

**时间投入**: 8-16 小时  
**产出**: 
- AutoSA 关键算法笔记
- 与 mlir-systolic 的对应关系分析
- 参数化设计输入

### 建议 3: 启动 Phase 1 (下周)

**准备工作**:
1. 代码审视: 标记所有硬编码位置
2. 设计评审: 确认参数化设计
3. 测试计划: 制定 ST0-ST5 的测试用例

**开发工作**: 
- 按 NEXT_STEPS_TECHNICAL_ROADMAP.md 的计划
- 每日进度报告
- 周末前完成 Day 1-2 的工作

**时间投入**: 5-7 天

### 建议 4: 定期同步 (持续)

**周期**: 每周一次技术同步

**讨论内容**:
1. 本周完成情况
2. 遇到的技术障碍
3. 与 AutoSA 的发现
4. 下周计划调整

**参与者**: 核心开发者 + 项目负责人

---

## 关键问题 Q&A

### Q1: 为什么现在需要进行此整理?

**A**: 
1. 项目已经有基础实现，是时候评估和规划扩展
2. 硬编码限制系统难以维护和扩展
3. 重构前的整理可以避免后续混乱
4. 为拉取 AutoSA 代码进行准备

### Q2: Phase 1 (Spacetime 参数化) 能否保持向后兼容?

**A**: 
是的。设计上会:
1. 保留现有的 API，添加新的参数化版本
2. 在 deprecated 旧 API
3. 逐步迁移到新版本
4. ST3 的行为不变 (作为默认)

### Q3: 多 Kernel 支持的具体规划是什么?

**A**: 
阶段性支持:
1. **Phase 2**: 框架准备 (通用分析、检测系统)
2. **Phase 3**: 具体 kernel 特化
   - MM (现有基础)
   - MTTKRP (4 层循环，多输入)
   - CNN (5+ 层循环，复杂访问)

### Q4: 为什么要在 Phase 1 中参数化 Spacetime，而不是先支持其他 Kernel?

**A**: 
优先级原因:
1. **Spacetime 参数化更基础** - 所有 kernel 都需要 spacetime 支持
2. **高风险** - 影响整个系统，需要早期重构
3. **独立性强** - 可以单独验证，不依赖 kernel 特化
4. **与 AutoSA 对应** - AutoSA 也是从 spacetime 参数化开始

### Q5: 如何验证 Spacetime 参数化的正确性?

**A**: 
多层验证:
1. **编译验证** - ST0-ST5 都能编译
2. **结构验证** - PE 模块维度正确
3. **对比验证** - PIPELINE 数与 AutoSA 一致
4. **硬件验证** - (后续) 在真实硬件上测试

---

## 参考资料

### 项目文件引用

| 文件 | 类型 | 用途 |
|------|------|------|
| [PROJECT_ORGANIZATION_AND_ANALYSIS.md](PROJECT_ORGANIZATION_AND_ANALYSIS.md) | 分析 | 了解项目全貌 |
| [CLEANUP_CHECKLIST.md](CLEANUP_CHECKLIST.md) | 执行 | 文档清理指南 |
| [CODE_ISSUES_DETAILED_ANALYSIS.md](CODE_ISSUES_DETAILED_ANALYSIS.md) | 分析 | 代码问题深入分析 |
| [NEXT_STEPS_TECHNICAL_ROADMAP.md](NEXT_STEPS_TECHNICAL_ROADMAP.md) | 规划 | 技术实施路线 |

### AutoSA 参考

| 资源 | 位置 | 学习价值 |
|------|------|---------|
| AutoSA 代码仓库 | https://github.com/UCLA-VAST/AutoSA | 高 |
| sa.cpp | main 处理流程 | 算法框架 |
| autosa_utils.cpp | 工具函数 | 具体实现 |
| autosa_*.cpp | 具体 Pass | 参考实现 |

### 相关文档

| 文件 | 位置 | 说明 |
|------|------|------|
| docs/project/PROJECT_STATUS.md | docs/project | 项目状态总结 |
| docs/spacetime/ | docs/spacetime | Spacetime 实现分析 |
| test/TEST_RESULTS.md | test | 测试结果 |

---

## 后续行动清单

### 本周 (1-6 周内)

- [ ] 阅读本整理报告的所有 4 个文档
- [ ] 执行文档清理 (参考 CLEANUP_CHECKLIST.md)
- [ ] 获取 AutoSA 源码，开始分析
- [ ] 在代码中标记硬编码位置 (FIXME 注释)
- [ ] 周末前完成 Spacetime 参数化设计

### 下周 (7-13 周内)

- [ ] 启动 Phase 1 开发 (Spacetime 参数化)
- [ ] Day 1-2: 数据结构和配置管理器
- [ ] Day 3-4: SpaceTimeAnalysis 和 SystolicTransform 重构
- [ ] Day 5-6: SystolicDataflowGeneration 重构
- [ ] Day 7: 代码生成和测试

### 两周内

- [ ] 完成 Phase 1 - Spacetime 参数化
- [ ] 所有 ST0-ST5 能够编译
- [ ] 与 AutoSA 输出对比验证
- [ ] 更新文档，反映新的代码结构

---

## 致谢和注意

### 致谢

感谢 AutoSA 团队的开源工作，为本项目提供了重要参考和验证基准。

### 版本管理建议

**重要**: 使用 git 分支进行重构工作

```bash
# 主分支保持稳定
git checkout -b refactor/spacetime-parametrization

# 定期 commit
git commit -m "refactor: parametrize spacetime for ST0-ST5 support"

# 完成后提交 PR，进行代码审查
```

### 沟通和协作

1. **日常沟通**: 每日 standup (15 min)
2. **周期同步**: 周五技术评审 (1 hour)
3. **问题跟踪**: 使用 GitHub Issues 或 Project
4. **文档更新**: 与代码同时更新

---

## 最终总结

### 项目阶段转变

```
开发阶段 1 (当前 ✓)
  └─ 目标: Spacetime=3 + MM kernel
  └─ 成果: 核心框架实现，AutoSA 功能验证
  
开发阶段 2 (规划中)
  └─ 目标: 参数化 + 通用化
  └─ 成果: 支持多 spacetime 和多 kernel
  
开发阶段 3 (后续)
  └─ 目标: 优化和验证
  └─ 成果: 生产级系统
```

### 成功因素

1. **清晰的问题分析** - 知道改什么
2. **详细的技术规划** - 知道怎么改
3. **循序渐进的实施** - 分阶段推进
4. **充分的验证** - 确保质量
5. **良好的沟通** - 团队同步

### 预期价值

- 📈 代码可维护性提高 50%+
- 🔧 系统可扩展性提高 10 倍
- ⚙️ 支持范围扩大 (6 种 ST, 3+ kernel)
- 🎯 与 AutoSA 功能对标

---

**报告完成时间**: 2026-01-06  
**报告状态**: ✅ 完成  
**推荐阅读顺序**: 本摘要 → PROJECT_ORGANIZATION_AND_ANALYSIS → CODE_ISSUES_DETAILED_ANALYSIS → NEXT_STEPS_TECHNICAL_ROADMAP

