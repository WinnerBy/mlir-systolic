# 随机读取问题分析结果

> **最后更新**: 2024-12  
> **目的**: 分析 AutoSA 生成的 HLS C++ 代码中的随机读取问题（写时重排问题）

---

## 分析范围

本次分析检查了以下 AutoSA 生成的 kernel：
1. **MTTKRP** (`kernel_mttkrp.cpp`)
2. **TTMc** (`kernel_ttmc.cpp`)
3. **CNN Small** (`kernel_cnn_small.cpp`)
4. **CNN Large** (`kernel_cnn_large.cpp`)
5. **LU** (`kernel_lu.cpp`)

---

## 问题定义

**写时重排问题**（随机读取问题）的特征：
1. 在 `IO_L2_in_intra_trans` 函数中使用**非线性索引表达式**访问 `local_*` 数组
2. 非线性索引表达式包含：
   - 除法：`index / divisor`
   - 取模：`index % divisor`
   - 复杂表达式：`(index1 * factor + index2) / divisor`
3. 在 `IO_L2_in_inter_trans` 中按顺序写入，但在 `intra_trans` 中按非线性索引读取，导致访问模式不匹配

---

## 分析结果

### 1. MTTKRP ✅ **确认存在写时重排问题**

#### 涉及的输入/输出数组：

**输入数组 A**：
- **问题位置**：`A_IO_L2_in_intra_trans`
- **数组声明**：`A_t16 local_A[16][2][16]`
- **写入模式**（`inter_trans`）：`local_A[c4][c5][c6]` - 顺序写入
- **读取模式**（`intra_trans`）：`local_A[c8][c5][8 * c6 / 16]` ⚠️ **非线性索引**
- **问题表达式**：`8 * c6 / 16`（除法）
- **严重程度**：🔴 **高**

**输入数组 B**：
- **问题位置**：`B_IO_L2_in_intra_trans`
- **数组声明**：`B_t8 local_B[2][1]`
- **写入模式**（`inter_trans`）：`local_B[c5][0]` - 顺序写入
- **读取模式**（`intra_trans`）：`local_B[c5][c7 / 8]` ⚠️ **非线性索引**
- **问题表达式**：`c7 / 8`（除法）
- **严重程度**：🟡 **中**（2D 数组，维度较小）

**输入数组 C**：
- **问题位置**：`C_IO_L2_in_intra_trans`
- **数组声明**：`C_t16 local_C[8][16]`
- **写入模式**（`inter_trans`）：`local_C[c6][c7]` - 顺序写入
- **读取模式**（`intra_trans`）：`local_C[c7][8 * c6 / 16]` ⚠️ **非线性索引**
- **问题表达式**：`8 * c6 / 16`（除法）
- **严重程度**：🔴 **高**

**输出数组 D**：
- **问题位置**：`D_drain_IO_L1_out_intra_trans`
- **数组声明**：`D_t4 local_D[16][2]`
- **写入模式**（`inter_trans`）：`local_D[c8][c7]` - 顺序写入
- **读取模式**（`intra_trans`）：`local_D[c8][c7 / 4]` ⚠️ **非线性索引**
- **问题表达式**：`c7 / 4`（除法）
- **严重程度**：🟡 **中**（2D 数组，维度较小）

---

### 2. TTMc ✅ **确认存在写时重排问题**

#### 涉及的输入/输出数组：

**输入数组 A**：
- **问题位置**：`A_IO_L2_in_intra_trans`
- **数组声明**：`A_t16 local_A[1][32][8]`
- **写入模式**（`inter_trans`）：`local_A[0][c6][c7]` - 顺序写入
- **读取模式**（`intra_trans`）：`local_A[0][c7][8 * c8 / 16]` ⚠️ **非线性索引**
- **问题表达式**：`8 * c8 / 16`（除法）
- **严重程度**：🔴 **高**

**输入数组 B**：
- **问题位置**：`B_IO_L2_in_intra_trans`
- **数组声明**：`B_t8 local_B[32][1]`
- **写入模式**（`inter_trans`）：`local_B[c6][0]` - 顺序写入
- **读取模式**（`intra_trans`）：`local_B[c7][c10 / 8]` ⚠️ **非线性索引**
- **问题表达式**：`c10 / 8`（除法）
- **严重程度**：🟡 **中**（2D 数组，维度较小）

**输入数组 C**：
- **问题位置**：`C_IO_L2_in_intra_trans`
- **数组声明**：`C_t16 local_C[16][8]`
- **写入模式**（`inter_trans`）：`local_C[c6][c7]` - 顺序写入
- **读取模式**（`intra_trans`）：`local_C[8*c6 + c9][8 * c8 / 16]` ⚠️ **非线性索引**
- **问题表达式**：`8*c6 + c9`（加法）和 `8 * c8 / 16`（除法）
- **严重程度**：🔴 **高**（包含加法和除法）

**输出数组 D**：
- **问题位置**：`D_drain_IO_L1_out_intra_trans`
- **数组声明**：`D_t4 local_D[1][32][4]`
- **写入模式**（`inter_trans`）：`local_D[0][c10][c11]` - 顺序写入
- **读取模式**（`intra_trans`）：`local_D[0][c10][(8 * c6 + c9) / 4]` ⚠️ **非线性索引**
- **问题表达式**：`(8 * c6 + c9) / 4`（乘法和除法）
- **严重程度**：🟡 **中**（3D 数组，但第一维为 1）

---

### 3. CNN Small ✅ **确认存在写时重排问题**

#### 涉及的输入/输出数组：

**输入数组 cin**：
- **问题位置**：`cin_IO_L2_in_intra_trans`
- **数组声明**：`cin_t8 local_cin[4][6][1]`
- **写入模式**（`inter_trans`）：`local_cin[c8][c9][0]` - 顺序写入
- **读取模式**（`intra_trans`）：`local_cin[c11 + c8][c10 + c9][2 * c7 / 8]` ⚠️ **非线性索引**
- **问题表达式**：`c11 + c8`（加法）、`c10 + c9`（加法）、`2 * c7 / 8`（除法）
- **严重程度**：🟡 **中**（包含加法和除法，但第三维为 1）

**输入数组 w**：
- **问题位置**：`w_IO_L2_in_intra_trans`
- **数组声明**：`w_t8 local_w[4][3][3][1]`
- **写入模式**（`inter_trans`）：`local_w[c10][c8][c9][0]` - 顺序写入
- **读取模式**（`intra_trans`）：`local_w[c12][c8][c9][2 * c7 / 8]` ⚠️ **非线性索引**
- **问题表达式**：`2 * c7 / 8`（除法）
- **严重程度**：🟡 **中**（4D 数组，但第四维为 1）

**输出数组 cout**：
- **问题位置**：`cout_drain_IO_L1_out_intra_trans`
- **数组声明**：`cout_t4 local_cout[4][6][1]`
- **写入模式**（`inter_trans`）：`local_cout[c11][c10][c12]` - 顺序写入
- **读取模式**（`intra_trans`）：`local_cout[c11][c10][c12 / 4]` ⚠️ **非线性索引**
- **问题表达式**：`c12 / 4`（除法）
- **严重程度**：🟡 **中**（3D 数组，但第三维为 1）

---

### 4. CNN Large ✅ **确认存在写时重排问题**

#### 涉及的输入/输出数组：

**输入数组 cin**：
- **问题位置**：`cin_IO_L2_in_intra_trans`
- **数组声明**：`cin_t16 local_cin[6][16][4]`
- **写入模式**（`inter_trans`）：`local_cin[c8][c9][c10]` - 顺序写入
- **读取模式**（`intra_trans`）：`local_cin[c11 + c8][c10 + 7*c6 + c9][8 * c7 / 16]` ⚠️ **非线性索引**
- **问题表达式**：`c11 + c8`（加法）、`c10 + 7*c6 + c9`（加法和乘法）、`8 * c7 / 16`（除法）
- **严重程度**：🔴 **高**（包含复杂的加法和乘法表达式）

**输入数组 w**：
- **问题位置**：`w_IO_L2_in_intra_trans`
- **数组声明**：`w_t16 local_w[4][3][3][4]`
- **写入模式**（`inter_trans`）：`local_w[c10][c8][c9][c11]` - 顺序写入
- **读取模式**（`intra_trans`）：`local_w[c12][c8][c9][8 * c7 / 16]` ⚠️ **非线性索引**
- **问题表达式**：`8 * c7 / 16`（除法）
- **严重程度**：🟡 **中**（4D 数组，但第四维较小）

**输出数组 cout**：
- **问题位置**：`cout_drain_IO_L1_out_intra_trans`
- **数组声明**：`cout_t4 local_cout[6][16][1]`
- **写入模式**（`inter_trans`）：`local_cout[c11][c10 + 7*c6][c12]` - 顺序写入（但包含加法）
- **读取模式**（`intra_trans`）：`local_cout[c11][c10 + 7*c6][c12 / 4]` ⚠️ **非线性索引**
- **问题表达式**：`c10 + 7*c6`（加法和乘法）、`c12 / 4`（除法）
- **严重程度**：🟡 **中**（3D 数组，但第三维为 1）

---

### 5. LU ✅ **未发现写时重排问题**

**分析结果**：
- LU kernel 使用模板函数和不同的数据流结构
- 主要使用 `IO_L1_in` 而不是 `IO_L2_in`
- 数组访问模式相对简单，未发现明显的非线性索引表达式
- 在 `U_drain_IO_L1_out_intra_trans` 中发现表达式 `(-p0 + c2) / 4`，但这是输出 drain 模块，不是输入 IO 模块，且表达式相对简单
- **结论**：✅ **未发现写时重排问题**（输入数组无问题）

---

## 总结

### 存在写时重排问题的 Kernel

| Kernel | 涉及的数组 | 问题数量 | 严重程度 |
|--------|-----------|---------|---------|
| **MTTKRP** | A, B, C, D | 4 个 | 🔴 高（A, C）🟡 中（B, D） |
| **TTMc** | A, B, C, D | 4 个 | 🔴 高（A, C）🟡 中（B, D） |
| **CNN Small** | cin, w, cout | 3 个 | 🟡 中（所有） |
| **CNN Large** | cin, w, cout | 3 个 | 🔴 高（cin）🟡 中（w, cout） |
| **LU** | - | 0 个 | ✅ 无问题 |

### 问题模式

1. **除法表达式**：最常见的问题模式
   - `8 * c6 / 16`
   - `c7 / 8`
   - `c7 / 4`
   - `2 * c7 / 8`

2. **加法和乘法表达式**：
   - `c11 + c8`
   - `8*c6 + c9`
   - `c10 + 7*c6 + c9`

3. **组合表达式**：
   - `(8 * c6 + c9) / 4`
   - `c10 + 7*c6 + c9`

### 修复建议

对于所有存在写时重排问题的 kernel，建议采用与 MTTKRP 相同的修复方法：

1. **数组维度重排**：将非线性索引移到数组的中间维度
2. **写入时重排**：在 `inter_trans` 中写入时使用重排后的布局
3. **读取时使用重排后的布局**：在 `intra_trans` 中读取时使用重排后的布局

---

## 参考

- [随机读取问题分析](RANDOM_ACCESS_ISSUE_ANALYSIS.md) - MTTKRP 的具体问题和修复方法
- [随机读取理论分析](RANDOM_ACCESS_THEORETICAL_ANALYSIS.md) - 基于数学表达式的理论分析

