# 随机读取问题分析结果

> **最后更新**: 2024-12  
> **目的**: 分析 AutoSA 生成的 HLS C 文件中存在的随机读取问题

---

## 分析概述

本分析基于 `/home/user/work/mlir-systolic/autosa_hls_output/` 目录下的 AutoSA 生成的 HLS C 文件：
- `kernel_mttkrp.cpp` - MTTKRP 运算
- `kernel_ttmc.cpp` - TTMc 运算
- `kernel_cnn_small.cpp` - CNN 小规模
- `kernel_cnn_large.cpp` - CNN 大规模
- `kernel_lu.cpp` - LU 分解

**分析方法**：
1. 检查 `IO_L2_in_intra_trans` 函数中的数组访问模式
2. 查找非线性索引表达式（包含除法、取模等）
3. 对比 `inter_trans`（写入）和 `intra_trans`（读取）的访问模式
4. 识别需要写时重排的数组

---

## 1. MTTKRP (Matricized Tensor Times Khatri-Rao Product)

### 1.1 问题确认

**文件**: `kernel_mttkrp.cpp`

**涉及的数组**：

#### A 数组（输入）
- **数组声明**: `A_t16 local_A[16][2][16]`
- **写入模式** (`inter_trans`): `local_A[c4][c5][c6] = out_data;`
  - `c4`: 0-15 (顺序)
  - `c5`: 0-1 (顺序)
  - `c6`: 0-15 (顺序)
- **读取模式** (`intra_trans`): `local_A[c8][c5][8 * c6 / 16]`
  - `c8`: 0-15 (顺序)
  - `c5`: 0-1 (顺序)
  - `8 * c6 / 16`: **非线性索引** ⚠️
    - `c6=0-1`: `0`
    - `c6=2-3`: `1`
    - `c6=4-5`: `2`
    - ... (每 2 个 c6 值对应一个索引值)

**问题分析**：
- ✅ **确认存在随机读取问题**
- 写入顺序：`[c4][c5][c6]` (顺序访问)
- 读取顺序：`[c8][c5][8 * c6 / 16]` (非线性索引)
- **需要写时重排**：将 `local_A` 的维度从 `[16][2][16]` 重排为 `[2][16][16]`，使非线性索引移到中间维度

#### B 数组（输入）
- **数组声明**: `B_t8 local_B[2][1]`
- **写入模式** (`inter_trans`): `local_B[c4][0] = out_data;`
- **读取模式** (`intra_trans`): `local_B[c5][c7 / 8]`
  - `c7 / 8`: **非线性索引** ⚠️
    - `c7=0-7`: `0`
    - `c7=8-15`: `1`
    - ...

**问题分析**：
- ⚠️ **可能存在随机读取问题**（但数组较小，影响可能较小）

#### C 数组（输入）
- **数组声明**: `C_t16 local_C[8][16]`
- **写入模式** (`inter_trans`): `local_C[c4][c5] = out_data;`
- **读取模式** (`intra_trans`): `local_C[c7][8 * c6 / 16]`
  - `8 * c6 / 16`: **非线性索引** ⚠️

**问题分析**：
- ⚠️ **可能存在随机读取问题**

#### D 数组（输出，Drain）
- **数组声明**: `D_t4 local_D[16][2]`
- **写入模式** (PE): `local_D[c8][c7 / 4] = out_data;`
- **读取模式** (`drain_intra_trans`): `local_D[c8][c7 / 4]`
  - `c7 / 4`: **非线性索引** ⚠️

**问题分析**：
- ⚠️ **可能存在随机读取问题**（Drain 模块，影响可能较小）

---

## 2. TTMc (Tensor Times Matrix Chain)

### 2.1 问题确认

**文件**: `kernel_ttmc.cpp`

**涉及的数组**：

#### A 数组（输入）
- **数组声明**: `A_t16 local_A[1][32][8]`
- **写入模式** (`inter_trans`): `local_A[0][c6][c7] = out_data;`
  - `c6`: 0-31 (顺序)
  - `c7`: 0-7 (顺序)
- **读取模式** (`intra_trans`): `local_A[0][c7][8 * c8 / 16]`
  - `c7`: 0-31 (顺序)
  - `8 * c8 / 16`: **非线性索引** ⚠️
    - `c8=0-1`: `0`
    - `c8=2-3`: `1`
    - `c8=4-5`: `2`
    - ... (每 2 个 c8 值对应一个索引值)

**问题分析**：
- ✅ **确认存在随机读取问题**
- 写入顺序：`[0][c6][c7]` (顺序访问)
- 读取顺序：`[0][c7][8 * c8 / 16]` (非线性索引，且 c6 和 c7 维度交换)
- **需要写时重排**：将 `local_A` 的维度从 `[1][32][8]` 重排为 `[1][8][32]`，使非线性索引移到中间维度

#### B 数组（输入）
- **数组声明**: `B_t8 local_B[32][1]`
- **写入模式** (`inter_trans`): `local_B[c5][0] = out_data;`
- **读取模式** (`intra_trans`): `local_B[c7][c10 / 8]`
  - `c10 / 8`: **非线性索引** ⚠️

**问题分析**：
- ⚠️ **可能存在随机读取问题**

#### C 数组（输入）
- **数组声明**: `C_t16 local_C[16][8]`
- **写入模式** (`inter_trans`): `local_C[c4][c5] = out_data;`
- **读取模式** (`intra_trans`): `local_C[8*c6 + c9][8 * c8 / 16]`
  - `8*c6 + c9`: **复杂索引表达式** ⚠️
  - `8 * c8 / 16`: **非线性索引** ⚠️

**问题分析**：
- ✅ **确认存在随机读取问题**（两个非线性索引）

#### D 数组（输出，Drain）
- **数组声明**: `D_t4 local_D[1][8][4]`
- **写入模式** (PE): `local_D[0][c10][(8 * c6 + c9) / 4] = out_data;`
- **读取模式** (`drain_intra_trans`): `local_D[0][c10][(8 * c6 + c9) / 4]`
  - `(8 * c6 + c9) / 4`: **复杂非线性索引** ⚠️

**问题分析**：
- ⚠️ **可能存在随机读取问题**（Drain 模块）

---

## 3. CNN Small

### 3.1 问题确认

**文件**: `kernel_cnn_small.cpp`

**涉及的数组**：

#### cin 数组（输入特征图）
- **数组声明**: `cin_t8 local_cin[4][6][1]`
- **写入模式** (`inter_trans`): `local_cin[c5][c6][0] = out_data;`
  - `c5`: 0-3 (顺序)
  - `c6`: 0-5 (顺序)
- **读取模式** (`intra_trans`): `local_cin[c11 + c8][c10 + c9][2 * c7 / 8]`
  - `c11 + c8`: **索引偏移**（可能非线性）
  - `c10 + c9`: **索引偏移**（可能非线性）
  - `2 * c7 / 8`: **非线性索引** ⚠️
    - `c7=0-3`: `0`
    - `c7=4-7`: `1`

**问题分析**：
- ⚠️ **可能存在随机读取问题**（滑动窗口访问 + 非线性索引）

#### w 数组（卷积核）
- **数组声明**: `w_t8 local_w[4][3][3][1]`
- **写入模式** (`inter_trans`): `local_w[c5][c6][c7][0] = out_data;`
- **读取模式** (`intra_trans`): `local_w[c12][c8][c9][2 * c7 / 8]`
  - `2 * c7 / 8`: **非线性索引** ⚠️

**问题分析**：
- ⚠️ **可能存在随机读取问题**

#### cout 数组（输出特征图，Drain）
- **数组声明**: `cout_t4 local_cout[4][6][1]`
- **写入模式** (PE): `local_cout[c11][c10][c12 / 4] = out_data;`
- **读取模式** (`drain_intra_trans`): `local_cout[c11][c10][c12 / 4]`
  - `c12 / 4`: **非线性索引** ⚠️

**问题分析**：
- ⚠️ **可能存在随机读取问题**（Drain 模块）

---

## 4. CNN Large

### 4.1 问题确认

**文件**: `kernel_cnn_large.cpp`

**涉及的数组**：

#### cin 数组（输入特征图）
- **数组声明**: `cin_t16 local_cin[6][16][4]`
- **写入模式** (`inter_trans`): `local_cin[c5][c6][c7] = out_data;`
  - `c5`: 0-5 (顺序)
  - `c6`: 0-15 (顺序)
  - `c7`: 0-3 (顺序)
- **读取模式** (`intra_trans`): `local_cin[c11 + c8][c10 + 7*c6 + c9][8 * c7 / 16]`
  - `c11 + c8`: **索引偏移**（可能非线性）
  - `c10 + 7*c6 + c9`: **复杂索引表达式** ⚠️
  - `8 * c7 / 16`: **非线性索引** ⚠️
    - `c7=0-1`: `0`
    - `c7=2-3`: `1`
    - `c7=4-5`: `2`
    - `c7=6-7`: `3`

**问题分析**：
- ✅ **确认存在随机读取问题**（滑动窗口访问 + 复杂索引表达式 + 非线性索引）

#### w 数组（卷积核）
- **数组声明**: `w_t16 local_w[4][3][3][4]`
- **写入模式** (`inter_trans`): `local_w[c5][c6][c7][c8] = out_data;`
- **读取模式** (`intra_trans`): `local_w[c12][c8][c9][8 * c7 / 16]`
  - `8 * c7 / 16`: **非线性索引** ⚠️

**问题分析**：
- ⚠️ **可能存在随机读取问题**

#### cout 数组（输出特征图，Drain）
- **数组声明**: `cout_t4 local_cout[6][16][1]`
- **写入模式** (PE): `local_cout[c11][c10 + 7*c6][c12 / 4] = out_data;`
- **读取模式** (`drain_intra_trans`): `local_cout[c11][c10 + 7*c6][c12 / 4]`
  - `c10 + 7*c6`: **复杂索引表达式** ⚠️
  - `c12 / 4`: **非线性索引** ⚠️

**问题分析**：
- ⚠️ **可能存在随机读取问题**（Drain 模块）

---

## 5. LU Decomposition

### 5.1 问题确认

**文件**: `kernel_lu.cpp`

**注意**: LU 分解没有 `IO_L2_in_intra_trans` 函数，它使用 `IO_L1_in_intra_trans`。

**涉及的数组**：

#### U 数组（输出，Drain）
- **数组声明**: `U_t4 local_U[1][8]`
- **写入模式** (PE): `local_U[0][(-p0 + c2) / 4] = out_data;`
- **读取模式** (`drain_intra_trans`): `local_U[0][(-p0 + c2) / 4]`
  - `(-p0 + c2) / 4`: **复杂非线性索引** ⚠️

**问题分析**：
- ⚠️ **可能存在随机读取问题**（Drain 模块，但数组较小）

---

## 6. 总结

### 6.1 确认存在随机读取问题的 Kernel

| Kernel | 数组 | 问题严重程度 | 需要写时重排 |
|--------|------|------------|------------|
| **MTTKRP** | A | 🔴 **高** | ✅ 是 |
| **MTTKRP** | B | 🟡 **中** | ⚠️ 可能 |
| **MTTKRP** | C | 🟡 **中** | ⚠️ 可能 |
| **TTMc** | A | 🔴 **高** | ✅ 是 |
| **TTMc** | B | 🟡 **中** | ⚠️ 可能 |
| **TTMc** | C | 🔴 **高** | ✅ 是 |
| **CNN Small** | cin | 🟡 **中** | ⚠️ 可能 |
| **CNN Small** | w | 🟡 **中** | ⚠️ 可能 |
| **CNN Large** | cin | 🔴 **高** | ✅ 是 |
| **CNN Large** | w | 🟡 **中** | ⚠️ 可能 |
| **LU** | U (Drain) | 🟢 **低** | ❌ 否（数组小） |

### 6.2 需要优先处理的 Kernel

1. **MTTKRP - A 数组** ✅ 已确认并修复
2. **TTMc - A 数组** 🔴 **高优先级**（与 MTTKRP 类似）
3. **TTMc - C 数组** 🔴 **高优先级**（两个非线性索引）
4. **CNN Large - cin 数组** 🔴 **高优先级**（滑动窗口 + 复杂索引）

### 6.3 修复建议

**对于需要写时重排的数组**：

1. **数组维度重排**：
   - MTTKRP A: `[16][2][16]` → `[2][16][16]`
   - TTMc A: `[1][32][8]` → `[1][8][32]`
   - TTMc C: `[16][8]` → `[8][16]`（需要分析具体访问模式）
   - CNN Large cin: `[6][16][4]` → 需要分析具体访问模式

2. **写入时重排**：
   - 在 `inter_trans` 中写入时，使用重排后的维度顺序

3. **读取时使用重排后的布局**：
   - 在 `intra_trans` 中读取时，使用重排后的布局，使非线性索引移到中间维度

---

## 7. 参考

- [随机读取问题分析](RANDOM_ACCESS_ISSUE_ANALYSIS.md) - MTTKRP 的具体问题和修复方法
- [随机读取理论分析](RANDOM_ACCESS_THEORETICAL_ANALYSIS.md) - 基于数学表达式的理论分析

