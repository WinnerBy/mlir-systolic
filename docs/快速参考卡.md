# mlir-systolic 快速参考卡 (Quick Reference)

> 一页纸快速查询，适合贴在显示器旁或打印

---

## 🚀 五分钟速览

### 项目现状
- ✅ Spacetime=3 + MM kernel 完整实现
- ⚠️ 硬编码限制系统只支持一种配置
- 📋 需要参数化重构和功能扩展

### 核心问题 (Top 5)
1. **Spacetime=3 硬编码** → 只支持一种 spacetime
2. **Kernel 特异性** → 只支持 MM kernel
3. **循环体迁移缺失** → 代码生成不完整
4. **配置流混乱** → 参数传递不规范
5. **依赖分析不完整** → 支持不足

### 后续计划 (Timeline)
| Phase | 工作 | 时间 | 完成日期 |
|-------|------|------|---------|
| 1 | Spacetime 参数化 (ST0-ST5) | 5-7 天 | 2026-01-31 |
| 2 | Kernel 通用化 (N 维) | 5-7 天 | 2026-02-28 |
| 3 | 多 Kernel 支持 | 3-5 天 | 2026-03-31 |
| 4 | 硬件验证 | 4-6 周 | 2026-04-30 |

---

## 📍 代码问题位置速查

### Spacetime=3 硬编码

```
SystolicTransform.cpp
  ├─ 行 ~185-200: 空间循环硬编码为 [0,1]
  └─ 行 ~210-220: 时间循环硬编码为 2+

SystolicDataflowGeneration.cpp
  ├─ 行 ~210-240: 数据流方向硬编码
  └─ 行 ~350-400: PE 阵列维度假设

SystolicDataflowToHLS.cpp
  └─ 行 ~40-80: 循环结构固定为 3 层

EmitHLSCpp
  └─ 行 ~300-350: 数组维度硬编码为 3D
```

### 配置流

```
Affine IR
  ↓ SystolicTransform Pass
  ├─ 分析 → SpaceTimeInfo
  └─ 存储 → 函数属性
        ↓
       (hardcoded 为字符串)
        ↓ SystolicDataflowGeneration Pass
        ├─ 读取 → 属性转 SystolicConfig
        └─ 存储 → dataflow 操作
             ↓ HLS Code Generator
             └─ 读取 → 参数化代码生成
```

**问题**: 多次转换，容易丢失信息

---

## 🛠️ 实施优先级

### P1 (立即处理)
- [ ] Spacetime 参数化重构
- [ ] 循环体迁移实现
- [ ] 代码标记 (FIXME)

**工作量**: 10-15 天

### P2 (短期处理)
- [ ] Kernel 通用化
- [ ] 配置管理改进
- [ ] 写时重排扩展

**工作量**: 5-10 天

### P3 (后续优化)
- [ ] 双缓冲逻辑完善
- [ ] 依赖分析增强
- [ ] 硬件验证

**工作量**: 4-6 周

---

## 📚 文档速查

### 关键文档 (按重要性)

| 文档 | 用途 | 字数 | 读时 |
|------|------|------|------|
| [整理工作总结](整理工作总结.md) | 概览 | 5K | 20 min |
| [PROJECT_ORGANIZATION_AND_ANALYSIS](PROJECT_ORGANIZATION_AND_ANALYSIS.md) | 规划 | 12K | 40 min |
| [CODE_ISSUES_DETAILED_ANALYSIS](CODE_ISSUES_DETAILED_ANALYSIS.md) | 问题分析 | 10K | 50 min |
| [NEXT_STEPS_TECHNICAL_ROADMAP](NEXT_STEPS_TECHNICAL_ROADMAP.md) | 技术方案 | 15K | 75 min |

### 快速查询

**"我应该删除哪些文件?"**
→ [CLEANUP_CHECKLIST.md](CLEANUP_CHECKLIST.md)

**"Spacetime=3 硬编码在哪?"**
→ CODE_ISSUES_DETAILED_ANALYSIS.md → 问题 1

**"Phase 1 怎么实施?"**
→ NEXT_STEPS_TECHNICAL_ROADMAP.md → Phase 1

**"项目现在是什么状态?"**
→ 整理工作总结.md → 执行摘要

---

## 💾 文件操作速查

### 删除 test/ 文件

```bash
# 删除这 15 个文件:
rm test/PASS_REGISTRATION_FIX.md
rm test/PASS_REGISTRATION_SUCCESS.md
rm test/PASS_CHECK_SUMMARY.md
rm test/PASS_STATUS_SUMMARY.md
rm test/DEBUG_FIX_SUMMARY.md
# ... (其他 10 个，见 CLEANUP_CHECKLIST.md)
```

### 整合 docs/spacetime

```bash
# 合并所有 ST3 分析到单个文件
# ST3_DETAILED_CODE_ANALYSIS.md +
# ST3_FUNCTION_DIFF_ANALYSIS.md +
# ST3_CODE_VERIFICATION.md +
# ST3_OPTIMIZATION_ANALYSIS.md
# → ST3_IMPLEMENTATION_REPORT.md
```

### Git 工作流

```bash
# 创建分支
git checkout -b refactor/spacetime-parametrization

# 定期 commit
git add .
git commit -m "refactor: parametrize spacetime for ST0-ST5 support"

# 完成后提交 PR
git push origin refactor/spacetime-parametrization
```

---

## 🧪 测试检查清单

### 编译测试

- [ ] ST0 能编译
- [ ] ST1 能编译
- [ ] ST2 能编译
- [ ] ST3 能编译 (现有功能保持)
- [ ] ST4 能编译
- [ ] ST5 能编译

### 结构验证

- [ ] PE 模块维度正确
- [ ] IO 模块结构正确
- [ ] 数据流方向正确
- [ ] PIPELINE 数量与 AutoSA 一致

### 对比验证

- [ ] PIPELINE 数: AutoSA = mlir-systolic (±0)
- [ ] 代码行数: 差异 ±10%
- [ ] 循环结构: 相同
- [ ] 函数数量: 接近

---

## 🎯 关键设计决策

### 决策 1: 参数化 SpaceTime

**数据结构**:
```cpp
struct ParametricSpaceTime {
  SmallVector<unsigned> spaceLoopDims;  // [0,1] 表示 [i,j]
  SmallVector<unsigned> timeLoopDims;   // [2] 表示 [k]
  unsigned peArrayDims;
  bool hasReductionLoop;
  DenseMap<Value, SystolicFlowDir> operandFlows;
};
```

### 决策 2: 通用 Kernel 检测

```cpp
struct KernelInfo {
  unsigned numLoops;
  SmallVector<StringRef> loopNames;
  DenseMap<Value, AccessPattern> accessPatterns;
};
```

### 决策 3: 配置管理

**使用 MLIR Attribute 而非字符串**: 类型安全 + 验证

---

## ❓ 常见问题 (FAQ)

**Q: 为什么是 Phase 1-2-3 而不是其他顺序?**  
A: 因为 Spacetime 参数化是基础，Kernel 通用化依赖它。

**Q: Spacetime 参数化能否保持 ST3 不变?**  
A: 是的，ST3 作为默认配置，现有代码路径不变。

**Q: 何时需要获取 AutoSA 代码?**  
A: Phase 1 结束前，用于验证和参考。

**Q: 多 Kernel 支持的优先级是什么?**  
A: MM(完成) > MTTKRP(4 层) > CNN(5+ 层)

**Q: 硬件验证什么时候做?**  
A: Phase 3 之后，先完成功能实现。

---

## 📞 沟通清单

### 每日 Standup
- [ ] 昨日完成情况
- [ ] 今日计划
- [ ] 遇到的问题

### 周次评审 (周五)
- [ ] 本周完成的工作
- [ ] 代码审查
- [ ] 下周计划确认

### 技术同步 (适时)
- [ ] 设计决策讨论
- [ ] 与 AutoSA 对比结果
- [ ] 问题解决方案讨论

---

## 🚨 常见陷阱

| 陷阱 | 后果 | 预防 |
|------|------|------|
| 未添加 FIXME 注释 | 遗忘硬编码位置 | 列出所有位置 |
| 跳过 ST3 验证 | 破坏现有功能 | 保留 ST3 测试 |
| 配置管理混乱 | 调试困难 | 使用规范的属性存储 |
| 缺少单元测试 | 问题难以发现 | 每个 Pass 都有测试 |
| 文档不更新 | 维护困难 | 代码和文档同时更新 |

---

## 🔍 代码审视清单

提交 PR 前检查:

- [ ] 支持参数化 spacetime?
- [ ] 支持 3+ 维循环?
- [ ] 处理了错误情况?
- [ ] 有充分的单元测试?
- [ ] 与 AutoSA 行为一致?
- [ ] 避免了新的硬编码?
- [ ] 更新了文档?
- [ ] 通过了静态检查?

---

## 📊 进度跟踪模板

```markdown
# Phase 1 进度报告 - Week N

## 完成情况
- [x] Day 1-2: 数据结构设计 (XX%)
- [ ] Day 3: Analysis 重构 (XX%)
- [ ] Day 4-5: Transform 重构 (XX%)

## 发现的问题
1. 问题 A - 影响 (修复中)
2. 问题 B - 影响 (待处理)

## 下周计划
- [ ] 完成 Day 5 工作
- [ ] 启动测试
- [ ] AutoSA 代码审视

## 指标
- 代码覆盖率: XX%
- 编译警告: X 个
- 单元测试通过率: XX%
```

---

## 最后的话

> **记住**: 这是一个重构项目，质量比速度更重要。
>
> 1. **充分测试** - 每个改动都验证
> 2. **清晰沟通** - 进度和问题及时报告
> 3. **代码审查** - PR 前充分评审
> 4. **文档更新** - 与代码同步维护

**成功标准**: 支持 6 种 ST，3+ kernel，代码与 AutoSA 可比。

🎯 **目标日期**: 2026-04-30

---

**最后更新**: 2026-01-06  
**打印友好**: ✅ 是  
**长度**: 1 页 (单栏) / 2 页 (双栏)

