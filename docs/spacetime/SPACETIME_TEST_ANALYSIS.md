# Space-time 测试结果分析

> **最后更新**: 2024-12-02  
> **目的**: 分析不同 Space-time 配置的测试结果和优化方向

---

## 测试概述

**测试时间**: 2024-12-02  
**测试配置**: 16 个矩阵乘法配置（Space-time 0-5）  
**测试结果**: ✅ **16/16 全部通过 (100%)**

---

## 测试结果详情

### Space-time=3 (2D [i,j])

**测试配置**: 11 个  
**通过率**: 11/11 (100%)

| 配置 | 代码行数 | 参考行数 | PIPELINE | 参考PIPELINE | 状态 |
|------|----------|----------|----------|--------------|------|
| `I32_J32_K32_ap8_lat4_simd1` | 1565 | 1499 | 24 | 24 | ✅ |
| `I32_J32_K32_ap8_lat4_simd2` | 1565 | 1538 | 24 | 24 | ✅ |
| `I64_J64_K64_ap16_lat4_simd1` | 2209 | 2015 | 24 | 24 | ✅ |
| `I64_J64_K64_ap16_lat8_simd1` | 1565 | 1501 | 24 | 24 | ✅ |
| `I64_J64_K64_ap16_lat8_simd2` | 1565 | 1540 | 24 | 24 | ✅ |
| `I64_J64_K64_ap16_lat8_simd4` | 1565 | 1544 | 24 | 24 | ✅ |
| `I64_J64_K64_ap32_lat8_simd1` | 2209 | 2045 | 24 | 24 | ✅ |
| `I64_J64_K64_ap32_lat16_simd1` | 1565 | 1517 | 24 | 24 | ✅ |
| `I128_J128_K128_ap32_lat16_simd1` | 1565 | 1517 | 24 | 24 | ✅ |
| `I128_J128_K128_ap32_lat16_simd2` | 1565 | 1556 | 24 | 24 | ✅ |
| `I128_J128_K128_ap64_lat16_simd1` | 2209 | 2045 | 24 | 24 | ✅ |

**分析**:
- ✅ PIPELINE 数量与参考代码完全一致（24 个）
- ⚠️ 代码行数略多于参考代码（平均多 66 行）
- ✅ 核心结构（kernel0, PE, IO_L）完整

---

### Space-time=0 (1D [i])

**测试配置**: 1 个  
**通过率**: 1/1 (100%)

| 配置 | 代码行数 | 参考行数 | PIPELINE | 参考PIPELINE | 状态 |
|------|----------|----------|----------|--------------|------|
| `I32_J32_K32_ap32_lat8_simd2` | 2209 | 1082 | 24 | 17 | ✅ |

**分析**:
- ⚠️ **PIPELINE 数量差异**: 生成 24 个，参考 17 个（多 7 个）
- ⚠️ **代码行数差异**: 生成 2209 行，参考 1082 行（多 1127 行，104%）
- ✅ 核心结构完整（kernel0: 2, PE: 3, IO_L: 454）

**问题分析**:
- 代码行数差异较大，可能是代码生成策略不同
- PIPELINE 数量过多，可能需要优化流水线插入策略

---

### Space-time=1 (1D [j])

**测试配置**: 1 个  
**通过率**: 1/1 (100%)

| 配置 | 代码行数 | 参考行数 | PIPELINE | 参考PIPELINE | 状态 |
|------|----------|----------|----------|--------------|------|
| `I32_J32_K32_ap32_lat8_simd2` | 2209 | 1082 | 24 | 17 | ✅ |

**分析**:
- ⚠️ **PIPELINE 数量差异**: 生成 24 个，参考 17 个（多 7 个）
- ⚠️ **代码行数差异**: 生成 2209 行，参考 1082 行（多 1127 行，104%）
- ✅ 核心结构完整（kernel0: 2, PE: 3, IO_L: 454）

**问题分析**:
- 与 Space-time=0 相同的问题
- 1D 脉动阵列的代码生成可能需要优化

---

### Space-time=2 (1D [k], 需要 reduction)

**测试配置**: 1 个  
**通过率**: 1/1 (100%)

| 配置 | 代码行数 | 参考行数 | PIPELINE | 参考PIPELINE | 状态 |
|------|----------|----------|----------|--------------|------|
| `I32_J32_K32_ap4_lat2_simd2` | 1565 | 1105 | 24 | 18 | ✅ |

**分析**:
- ⚠️ **PIPELINE 数量差异**: 生成 24 个，参考 18 个（多 6 个）
- ⚠️ **代码行数差异**: 生成 1565 行，参考 1105 行（多 460 行，42%）
- ✅ 核心结构完整（kernel0: 2, PE: 3, IO_L: 242）
- ✅ Reduction 支持正常

**问题分析**:
- Reduction 支持正常，但 PIPELINE 数量需要优化
- 代码行数差异中等，可能需要优化代码生成

---

### Space-time=4 (2D [i,k], 需要 reduction)

**测试配置**: 1 个  
**通过率**: 1/1 (100%)

| 配置 | 代码行数 | 参考行数 | PIPELINE | 参考PIPELINE | 状态 |
|------|----------|----------|----------|--------------|------|
| `I32_J32_K32_ap32_lat16_simd2` | 1565 | 1528 | 24 | 25 | ✅ |

**分析**:
- ⚠️ **PIPELINE 数量差异**: 生成 24 个，参考 25 个（少 1 个）
- ✅ **代码行数差异**: 生成 1565 行，参考 1528 行（多 37 行，2%）
- ✅ 核心结构完整（kernel0: 2, PE: 3, IO_L: 242）
- ✅ Reduction 支持正常

**问题分析**:
- 代码行数差异很小，接近参考代码
- PIPELINE 数量略少，可能需要增加 1 个

---

### Space-time=5 (2D [j,k], 需要 reduction)

**测试配置**: 1 个  
**通过率**: 1/1 (100%)

| 配置 | 代码行数 | 参考行数 | PIPELINE | 参考PIPELINE | 状态 |
|------|----------|----------|----------|--------------|------|
| `I32_J32_K32_ap32_lat16_simd2` | 1565 | 1520 | 24 | 25 | ✅ |

**分析**:
- ⚠️ **PIPELINE 数量差异**: 生成 24 个，参考 25 个（少 1 个）
- ✅ **代码行数差异**: 生成 1565 行，参考 1520 行（多 45 行，3%）
- ✅ 核心结构完整（kernel0: 2, PE: 3, IO_L: 242）
- ✅ Reduction 支持正常

**问题分析**:
- 与 Space-time=4 相同的问题
- 代码行数差异很小，接近参考代码

---

## 问题总结

### 1. PIPELINE 数量不一致

| Space-time | 生成的PIPELINE | 参考PIPELINE | 差异 | 优先级 |
|-----------|---------------|--------------|------|--------|
| 0 | 24 | 17 | +7 | 🔴 高 |
| 1 | 24 | 17 | +7 | 🔴 高 |
| 2 | 24 | 18 | +6 | 🔴 高 |
| 3 | 24 | 24 | 0 | ✅ 正常 |
| 4 | 24 | 25 | -1 | 🟡 中 |
| 5 | 24 | 25 | -1 | 🟡 中 |

**可能原因**:
- 流水线插入策略不同
- 循环展开策略不同
- 代码优化级别不同

**下一步工作**:
1. 分析参考代码的 PIPELINE 插入位置
2. 调整流水线插入策略
3. 优化循环展开和流水线平衡

---

### 2. 代码行数差异

| Space-time | 平均行数差异 | 差异百分比 | 优先级 |
|-----------|-------------|-----------|--------|
| 0 | +1127 | +104% | 🔴 高 |
| 1 | +1127 | +104% | 🔴 高 |
| 2 | +460 | +42% | 🟡 中 |
| 3 | +66 | +4% | 🟢 低 |
| 4 | +37 | +2% | 🟢 低 |
| 5 | +45 | +3% | 🟢 低 |

**可能原因**:
- 代码生成策略不同（更多辅助代码）
- 注释和格式差异
- 循环展开程度不同

**下一步工作**:
1. 分析代码行数差异的具体来源
2. 优化代码生成，减少冗余代码
3. 统一代码格式和注释风格

---

### 3. 功能正确性验证

**当前状态**: ⚠️ **待验证**

虽然所有配置都成功生成了代码，但需要验证：
1. 生成的代码功能是否正确
2. 性能是否与参考代码相当
3. 资源使用是否合理

**下一步工作**:
1. 编译生成的 HLS C++ 代码
2. 运行功能测试
3. 对比性能指标（延迟、吞吐量、资源使用）

---

## 下一步工作优先级

### 优先级 1: 优化 PIPELINE 数量（高优先级）

**目标**: 使生成的 PIPELINE 数量与参考代码一致

**工作项**:
1. 分析参考代码的 PIPELINE 插入位置和策略
2. 调整 `SystolicTransform` pass 的流水线插入逻辑
3. 针对不同 Space-time 实现不同的 PIPELINE 策略
4. 测试验证优化后的 PIPELINE 数量

**预期结果**:
- Space-time=0,1: PIPELINE 从 24 减少到 17
- Space-time=2: PIPELINE 从 24 减少到 18
- Space-time=4,5: PIPELINE 从 24 增加到 25

---

### 优先级 2: 优化代码行数（中优先级）

**目标**: 减少代码行数差异，特别是 Space-time=0,1,2

**工作项**:
1. 分析代码行数差异的具体来源
2. 优化代码生成，减少冗余代码
3. 统一代码格式和注释风格
4. 测试验证优化后的代码行数

**预期结果**:
- Space-time=0,1: 代码行数减少 50%+
- Space-time=2: 代码行数减少 30%+
- Space-time=3,4,5: 保持当前水平（差异已很小）

---

### 优先级 3: 功能正确性验证（中优先级）

**目标**: 验证生成的代码功能正确性

**工作项**:
1. 编译生成的 HLS C++ 代码
2. 运行功能测试（对比计算结果）
3. 性能测试（延迟、吞吐量）
4. 资源使用分析

**预期结果**:
- 所有配置的功能测试通过
- 性能指标与参考代码相当
- 资源使用合理

---

## 相关文档

- **测试结果**: `docs/TEST_RESULTS.md`
- **Spacetime 分析**: `docs/AUTOSA_SPACETIME_ANALYSIS.md`
- **测试脚本**: `test/test_other_spacetime.sh`

