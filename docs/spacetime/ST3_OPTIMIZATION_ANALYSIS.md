# Space-time=3 优化分析

> **创建时间**: 2024-12-02  
> **目的**: 分析 Space-time=3 的代码生成优化点

---

## 当前状态

### 测试结果总结

| 配置 | 代码行数 | 参考行数 | PIPELINE | 参考PIPELINE | 状态 |
|------|----------|----------|----------|--------------|------|
| `I32_J32_K32_ap8_lat4_simd1` | 1565 | 1499 | 24 | 24 | ✅ |
| `I32_J32_K32_ap8_lat4_simd2` | 1565 | 1538 | 24 | 24 | ✅ |
| `I64_J64_K64_ap16_lat4_simd1` | 2209 | 2015 | 24 | 24 | ✅ |
| `I64_J64_K64_ap16_lat8_simd1` | 1565 | 1501 | 24 | 24 | ✅ |
| `I64_J64_K64_ap16_lat8_simd2` | 1565 | 1540 | 24 | 24 | ✅ |
| `I64_J64_K64_ap16_lat8_simd4` | 1565 | 1544 | 24 | 24 | ✅ |
| `I64_J64_K64_ap32_lat8_simd1` | 2209 | 2045 | 24 | 24 | ✅ |
| `I64_J64_K64_ap32_lat16_simd1` | 1565 | 1517 | 24 | 24 | ✅ |
| `I128_J128_K128_ap32_lat16_simd1` | 1565 | 1517 | 24 | 24 | ✅ |
| `I128_J128_K128_ap32_lat16_simd2` | 1565 | 1556 | 24 | 24 | ✅ |
| `I128_J128_K128_ap64_lat16_simd1` | 2209 | 2045 | 24 | 24 | ✅ |

**分析**:
- ✅ **PIPELINE 数量**: 24 个，与参考代码完全一致
- ⚠️ **代码行数**: 平均多 66 行（约 4%）
- ✅ **核心结构**: 完整（kernel0, PE, IO_L）

---

## 优化目标

### 主要目标
1. **保持 PIPELINE 数量**: 24 个（已达成）✅
2. **减少代码行数**: 目标减少 30-50 行（接近参考代码）
3. **优化代码质量**: 减少冗余代码，统一格式

---

## 参考代码分析

### PIPELINE 插入位置分析

**参考代码**: `mm_st3_I32_J32_K32_ap8_lat4_simd1_kernel.cpp`

**PIPELINE 位置**（共 24 个）:
1. `A_IO_L3_in`: 1 个（第 49 行）
2. `A_IO_L3_in_serialize`: 1 个（第 74 行）
3. `A_IO_L2_in_intra_trans`: 1 个（第 105 行）
4. `A_IO_L2_in_inter_trans`: 2 个（第 140, 152 行）
5. `A_IO_L2_in_inter_trans_boundary`: 1 个（第 180 行）
6. `B_IO_L3_in`: 1 个（第 400 行）
7. `B_IO_L3_in_serialize`: 1 个（第 425 行）
8. `B_IO_L2_in_intra_trans`: 1 个（第 456 行）
9. `B_IO_L2_in_inter_trans`: 2 个（第 491, 503 行）
10. `B_IO_L2_in_inter_trans_boundary`: 1 个（第 531 行）
11. `PE_wrapper`: 3 个（第 760, 807, 833 行）
12. `PE_wrapper` (latency loop): 1 个（第 859 行）
13. `C_drain_IO_L1_out_intra_trans`: 1 个（第 892 行）
14. `C_drain_IO_L1_out_inter_trans`: 2 个（第 904, 930 行）
15. `C_drain_IO_L1_out_inter_trans_boundary`: 1 个（第 1053 行）
16. `C_drain_IO_L1_out`: 3 个（第 1068, 1102, 1133 行）
17. `C_drain_IO_L1_out_serialize`: 1 个（第 1157 行）

**PIPELINE 插入规则**:
- 最内层循环插入 PIPELINE
- 数据流操作（read/write）插入 PIPELINE
- 计算操作（MAC）插入 PIPELINE

---

## 代码行数差异分析

### 可能的原因

1. **注释和格式差异**:
   - 参考代码使用简洁的注释
   - 生成的代码可能有更多注释

2. **代码结构差异**:
   - 参考代码可能使用了更紧凑的结构
   - 生成的代码可能有更多辅助代码

3. **循环展开差异**:
   - 参考代码的循环展开程度可能不同
   - 生成的代码可能展开了更多循环

4. **变量声明差异**:
   - 参考代码可能合并了变量声明
   - 生成的代码可能有更多临时变量

---

## 优化策略

### 1. PIPELINE 插入优化

**当前状态**: ✅ PIPELINE 数量已正确（24 个）

**优化方向**:
- 确保 PIPELINE 插入位置与参考代码一致
- 优化 PIPELINE 的 II（Initiation Interval）设置

### 2. 代码行数优化

**策略**:
1. **减少冗余注释**:
   - 移除不必要的注释
   - 统一注释风格

2. **优化代码结构**:
   - 合并相似的代码块
   - 减少临时变量

3. **优化循环展开**:
   - 分析循环展开的必要性
   - 减少不必要的展开

4. **优化变量声明**:
   - 合并变量声明
   - 减少临时变量

### 3. 代码格式优化

**策略**:
1. **统一代码格式**:
   - 统一缩进
   - 统一命名风格

2. **优化代码布局**:
   - 减少空行
   - 优化代码分组

---

## 实施步骤

### 步骤 1: 详细对比分析

- [ ] 对比生成的代码和参考代码的结构
- [ ] 识别代码行数差异的具体来源
- [ ] 记录需要优化的点

### 步骤 2: PIPELINE 位置验证

- [ ] 验证 PIPELINE 插入位置与参考代码一致
- [ ] 检查 PIPELINE 的 II 设置
- [ ] 优化 PIPELINE 插入逻辑

### 步骤 3: 代码生成优化

- [ ] 优化注释生成
- [ ] 优化代码结构
- [ ] 优化循环展开
- [ ] 优化变量声明

### 步骤 4: 测试验证

- [ ] 运行所有 Space-time=3 的测试
- [ ] 验证 PIPELINE 数量（24 个）
- [ ] 验证代码行数（减少 30-50 行）
- [ ] 验证功能正确性

---

## 预期结果

### 优化后目标

| 配置 | 当前行数 | 参考行数 | 目标行数 | 减少行数 |
|------|----------|----------|----------|----------|
| `I32_J32_K32_ap8_lat4_simd1` | 1565 | 1499 | 1500-1520 | 45-65 |
| `I32_J32_K32_ap8_lat4_simd2` | 1565 | 1538 | 1540-1550 | 15-25 |
| `I64_J64_K64_ap16_lat4_simd1` | 2209 | 2015 | 2020-2040 | 169-189 |
| `I64_J64_K64_ap16_lat8_simd1` | 1565 | 1501 | 1505-1520 | 45-60 |
| `I64_J64_K64_ap16_lat8_simd2` | 1565 | 1540 | 1545-1555 | 10-20 |
| `I64_J64_K64_ap16_lat8_simd4` | 1565 | 1544 | 1549-1559 | 6-16 |
| `I64_J64_K64_ap32_lat8_simd1` | 2209 | 2045 | 2050-2070 | 139-159 |
| `I64_J64_K64_ap32_lat16_simd1` | 1565 | 1517 | 1522-1537 | 28-43 |
| `I128_J128_K128_ap32_lat16_simd1` | 1565 | 1517 | 1522-1537 | 28-43 |
| `I128_J128_K128_ap32_lat16_simd2` | 1565 | 1556 | 1561-1571 | -6-4 |
| `I128_J128_K128_ap64_lat16_simd1` | 2209 | 2045 | 2050-2070 | 139-159 |

**平均减少**: 30-50 行

---

## 相关文档

- **实施路线图**: `docs/IMPLEMENTATION_ROADMAP.md`
- **实现方案**: `docs/SPACETIME_IMPLEMENTATION_PLAN.md`
- **测试结果**: `docs/SPACETIME_TEST_ANALYSIS.md`

---

## 更新日志

- **2024-12-02**: 创建优化分析文档，开始 Space-time=3 优化

